# Azure DevOps Pipeline: Deploy to Production Environment
# Trigger: Manual only (no automatic triggers)
# Purpose: Controlled production deployment with approval gates

trigger: none  # Manual trigger only

pr: none  # No PR triggers

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: ENVIRONMENT
    value: 'prod'
  - name: AWS_REGION
    value: 'ap-southeast-2'

stages:
  # Stage 1: Pre-deployment Validation
  - stage: PreDeploymentChecks
    displayName: 'Pre-deployment Validation'
    jobs:
      - job: ValidateReadiness
        displayName: 'Validate Production Readiness'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '18.x'

          - task: AWSShellScript@1
            displayName: 'Run Unit Tests'
            inputs:
              awsCredentials: '$(AWS_SERVICE_CONNECTION)'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                cd infrastructure-shared && make test
                cd ../microservice-order-processor && make test

          - task: AWSShellScript@1
            displayName: 'Validate Configuration'
            inputs:
              awsCredentials: '$(AWS_SERVICE_CONNECTION)'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                echo "Validating production configuration..."
                # Add configuration validation checks here

  # Stage 2: Deploy Shared Infrastructure (with approval)
  - stage: DeployInfrastructure
    displayName: 'Deploy Shared Infrastructure'
    dependsOn: PreDeploymentChecks
    condition: succeeded()
    jobs:
      - deployment: DeploySharedInfra
        displayName: 'Deploy VPC, RDS, ALB, ECS Cluster'
        environment: 'production'  # Requires manual approval in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: NodeTool@0
                  displayName: 'Install Node.js'
                  inputs:
                    versionSpec: '18.x'

                - task: AWSShellScript@1
                  displayName: 'Bootstrap CDK (if needed)'
                  inputs:
                    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      cd infrastructure-shared
                      make bootstrap ENV=$(ENVIRONMENT)

                - task: AWSShellScript@1
                  displayName: 'Deploy Shared Infrastructure'
                  inputs:
                    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      cd infrastructure-shared
                      make deploy ENV=$(ENVIRONMENT)

  # Stage 3: Deploy Microservice (with approval)
  - stage: DeployMicroservice
    displayName: 'Deploy Order Processor Microservice'
    dependsOn: DeployInfrastructure
    condition: succeeded()
    jobs:
      - deployment: DeployOrderProcessor
        displayName: 'Build & Deploy Order Processor'
        environment: 'production'  # Requires manual approval in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: NodeTool@0
                  displayName: 'Install Node.js'
                  inputs:
                    versionSpec: '18.x'

                - task: Docker@2
                  displayName: 'Login to ECR'
                  inputs:
                    command: login
                    containerRegistry: '$(AWS_SERVICE_CONNECTION)'

                - task: AWSShellScript@1
                  displayName: 'Build and Push Docker Image'
                  inputs:
                    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      cd microservice-order-processor
                      make docker-build ENV=$(ENVIRONMENT)
                      make docker-push ENV=$(ENVIRONMENT)

                - task: AWSShellScript@1
                  displayName: 'Deploy Microservice'
                  inputs:
                    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      cd microservice-order-processor
                      make deploy ENV=$(ENVIRONMENT)

                - task: AWSShellScript@1
                  displayName: 'Display Service URL'
                  inputs:
                    awsCredentials: '$(AWS_SERVICE_CONNECTION)'
                    regionName: '$(AWS_REGION)'
                    scriptType: 'inline'
                    inlineScript: |
                      cd microservice-order-processor
                      make info ENV=$(ENVIRONMENT)

  # Stage 4: Post-deployment Validation
  - stage: PostDeploymentValidation
    displayName: 'Post-deployment Validation'
    dependsOn: DeployMicroservice
    condition: succeeded()
    jobs:
      - job: ValidateDeployment
        displayName: 'Validate Production Deployment'
        steps:
          - task: AWSShellScript@1
            displayName: 'Health Checks'
            inputs:
              awsCredentials: '$(AWS_SERVICE_CONNECTION)'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                echo "Running production health checks..."
                # Add health check commands here
                # Example: curl endpoints, validate metrics, check logs

          - task: AWSShellScript@1
            displayName: 'Monitor CloudWatch Alarms'
            inputs:
              awsCredentials: '$(AWS_SERVICE_CONNECTION)'
              regionName: '$(AWS_REGION)'
              scriptType: 'inline'
              inlineScript: |
                echo "Checking CloudWatch alarms..."
                aws cloudwatch describe-alarms \
                  --state-value ALARM \
                  --region $(AWS_REGION) \
                  --query 'MetricAlarms[?contains(AlarmName, `prod`)].AlarmName' \
                  --output table